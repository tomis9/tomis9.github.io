<!DOCTYPE html>
<html lang="en">
<head>

  <title>tomis9&#39;s cookbook</title>
  <link rel="shortcut icon" type='image/x-icon' href="https://tomis9.github.io/favicon.ico"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  
  <link rel="stylesheet" href="https://tomis9.github.io/css/bootstrap-toc.css">

  
  <link rel="stylesheet" href="https://tomis9.github.io/css/darcula.css">

  
  <link rel="stylesheet" href="https://tomis9.github.io/css/style.css">

  
  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">        
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Fascinate&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">

</head>


<body data-spy="scroll" data-target="#toc">



<nav id="navbar" class="navbar navbar-expand-md fixed-top navbar-hide transition">

  
  <a class="navbar-brand"></a>

  <button class="navbar-toggler float-xs-right" data-toggle="collapse" data-target="#collapsibleNavbar">
    Menu
  </button>

  <div class="collapse navbar-collapse" id="collapsibleNavbar">

    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://tomis9.github.io">Home</a>
      </li>
      
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Python</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/beautiful_soup/">beautiful soup</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/decorators/">decorators</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/sqlalchemy/">sqlAlchemy</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/testing/">testing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">R</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/cinr/">C in R</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rmariadb/">RMariaDB (former RMySQL)</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rcpp/">Rcpp</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/classess4/">classes - S4</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/data.table/">data.table</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/debugging/">debugging</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/ggplot2/">ggplot2</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/lubridate/">lubridate</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/packages/">packages</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rtags/">rTags</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/reshape2/">reshape2</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rstanarm/">rstanarm</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/shiny/">shiny</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/sqldf/">sqldf</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/tidyverse/">tidyverse</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Data engineering</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/hadoop/">hadoop</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/useful_processing/">useful processing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Machine learning</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/ml/">basic machine learning algorithms</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/validation/">model validation</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/useful_processing/">useful processing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">DevOps</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/docker/">docker</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/git/">git</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/heroku/">heroku</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/mesos/">mesos</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/vagrant/">vagrant</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Projects</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/vim_vs_emacs/">vim vs emacs - text mining to settle the editor war</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/cookbook/">writing a cookbook</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">scratchpad</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/hugo/">Hugo</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/file/">Rmarkdown total basics</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/caffee/">caffee</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/cassandra/">cassandra</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/featuretools/">featuretools</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/gitlab_ci/">gitlab-ci</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/kafka/">kafka</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/marathon/">marathon</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/nlp/">nlp</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/passing_arguments/">passing arguments to scripts</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/redis/">redis</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/tensorflow_serving/">tensorflow_serving</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/theano/">theano</a>
          
        </div>
      </li>
    
    </ul>

  </div>  

</nav>



<div class="jumbotron text-center" id="header">

  <div id="header-title">
      <a href="https://tomis9.github.io">tomis9&#39;s cookbook</a>
  </div>

  <p style="color: white;">data science tutorials and snippets prepared by tomis9</p> 

</div>


<nav id="toc" data-toggle="toc" class="sticky-top d-none d-xl-block"></nav>

<div class="article">

<div class="article-categories">
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://tomis9.github.io/categories/python" role="button">Python </a>
    &emsp;
  </br>
</div>
<div class="article-title">
  
  sqlAlchemy

</div>
<div class="article-info">
    Aug 25, 2018 &emsp;  &emsp; 3 minutes read
</div>



<h2 id="1-what-is-sqlalchemy-and-why-would-you-use-it">1. What is sqlAlchemy and why would you use it?</h2>

<ul>
<li><p>sqlAlchemy is a python module that enables you to connect to and use sql databases without writing code in sql;</p></li>

<li><p>using sqlAlchemy has several advantages:</p>

<ul>
<li><p>you will avoid using long sql strings in your code, which are difficult to read without syntax highlighting (unless you keep you sql queries in separate sql files);</p></li>

<li><p>you are not vulnerable to sql injection attacks anymore;</p></li>

<li><p>you can map your sql tables to pythonic objects with ORM (Object Relational Mapper). Most probably you will not use this functionality as a data scientist, but as a back-end or full-stack developer, you would use it a lot. Thanks to ORM you can create a whole logic of your database in Python, which produces much less mess at the end of the day;</p></li>
</ul></li>

<li><p>Basics of sqlAlchemy are very simple and you can just use it instead of pymysql or any other module you use. So, the last reason is: <em>why wouldn&rsquo;t you use it?</em></p></li>
</ul>

<h2 id="2-minimal-examples">2. Minimal examples</h2>

<h4 id="connection-string">connection string</h4>

<p>First of all, you need to connect to the database, so you have to:</p>

<ul>
<li><p>tell which database you want to connect to</p></li>

<li><p>and provide your credentials.</p></li>
</ul>

<p>Read credentials from a file. Happy people keep their mysql password in .my.cnf.</p>

<pre><code class="language-python">creds_path = os.path.join(os.getenv(&quot;HOME&quot;), '.my.cnf')
with open(creds_path) as c:
    creds = c.read().splitlines()
    user, password = (x[x.find(&quot;=&quot;)+1:] for x in creds[1:])
</code></pre>

<p>and then create a connection string.</p>

<pre><code class="language-python">connection_string = 'mysql://' + user + ':' + password + '@localhost/test'
</code></pre>

<h4 id="creating-a-table">creating a table</h4>

<pre><code class="language-python">import sqlalchemy
from sqlalchemy import Table, Column, Integer, String, MetaData

meta = sqlalchemy.MetaData(connection_string)
test1 = Table(
    'test1', meta,
    Column('id', Integer, primary_key=True, autoincrement=False),
    Column('text', String(30))
)

engine = sqlalchemy.create_engine(connection_string)
meta.create_all(engine)
</code></pre>

<p>Great, you&rsquo;ve just created you first table with sqlAlchemy! As you can see:</p>

<ul>
<li><p>we haven&rsquo;t written a single line of code in SQL;</p></li>

<li><p>we didn&rsquo;t have to provide a separate DDL file with SQL&rsquo;s create statement;</p></li>

<li><p>we could have define more tables before the <code>create_all</code> execution;</p></li>

<li><p>defining tables in sqlAlchemy does not differ much from creating them with plain SQL.</p></li>
</ul>

<h4 id="talking-about-the-table-in-code">&lsquo;talking about&rsquo; the table in code</h4>

<p>In sqlAlchemy we <code>map</code> an sql table (e.g. <code>test1</code>) to a python variable (e.g. <code>test1</code>) and then we refer to that variable when we want to select/insert/update/delete/do anything on that table.</p>

<pre><code class="language-python">test1 = sqlalchemy.Table('test1', meta, autoload=True)
</code></pre>

<p>In the example in section &lsquo;creating a table&rsquo; we have already defined that variable, so we don&rsquo;t have to download it&rsquo;s metadata again, but in general case, we want to inform Python about the structure of the table.</p>

<p>After that, we simply execute the statement. Have a look:</p>

<h4 id="inserting-data-to-the-table">inserting data to the table</h4>

<p>There are several ways to do that.</p>

<p>First one:</p>

<pre><code class="language-python">data = [{'id': 1, 'text': 'how'},
        {'id': 2, 'text': 'you'},
        {'id': 3, 'text': &quot;doin'&quot;},
        {'id': 4, 'text': '?'}]
stmt = test1.insert().values(data)
stmt.execute()
</code></pre>

<p>And the data is in the database.</p>

<p>You can also do this with pandas, but let&rsquo;s clear the table before reinserting the data:</p>

<pre><code class="language-python">stmt = test1.delete()
stmt.execute()
</code></pre>

<p>You can always write execute and the end of line:</p>

<pre><code class="language-python">test1.delete().execute()
</code></pre>

<pre><code class="language-python">import pandas as pd
df = pd.DataFrame(data)
df.to_sql('test1', engine, if_exists='append', index=False)
</code></pre>

<p>And the data is in the database.</p>

<h4 id="selecting-data">selecting data</h4>

<pre><code class="language-python">stmt = test1.select()
result = stmt.execute()
result.fetchall()
</code></pre>

<p>or</p>

<pre><code class="language-python">test1.select().execute().fetchall()
</code></pre>

<p>or even</p>

<pre><code class="language-python">pd.read_sql(test1.select(), engine)
</code></pre>

<h4 id="using-plain-old-sql">using plain old SQL</h4>

<p>You can still use plain old sql queries, if you don&rsquo;t feel comfortable with working on databases in Python:</p>

<pre><code class="language-python">engine = sqlalchemy.create_engine(connection_string)
connection = engine.connect()
result = connection.execute(&quot;select * from test1;&quot;)
colnames = result._metadata.keys
print(result.fetchall())

connection.close()
</code></pre>

<h2 id="3-useful-or-interesting-links">3. Useful or interesting links</h2>

<p>There is a whole discussion whether sqlAlchemy is not a overkill for data science.</p>

<ul>
<li><p><a href="http://danielweitzenfeld.github.io/passtheroc/blog/2014/10/12/datasci-sqlalchemy/">http://danielweitzenfeld.github.io/passtheroc/blog/2014/10/12/datasci-sqlalchemy/</a></p></li>

<li><p><a href="https://medium.freecodecamp.org/sqlalchemy-makes-etl-magically-easy-ab2bd0df928">https://medium.freecodecamp.org/sqlalchemy-makes-etl-magically-easy-ab2bd0df928</a></p></li>

<li><p><a href="https://medium.com/hacking-datascience/sqlalchemy-python-tutorial-abcc2ec77b57">https://medium.com/hacking-datascience/sqlalchemy-python-tutorial-abcc2ec77b57</a></p></li>

<li><p><a href="https://it.toolbox.com/blogs/garyeastwood/why-every-data-scientist-should-learn-sqlalchemy-103118">https://it.toolbox.com/blogs/garyeastwood/why-every-data-scientist-should-learn-sqlalchemy-103118</a></p></li>

<li><p><a href="https://github.com/dropbox/PyHive">https://github.com/dropbox/PyHive</a></p></li>

<li><p><a href="https://www.safaribooksonline.com/library/view/mastering-geospatial-analysis/9781788293334/44f54df4-f6c9-467d-8057-dee20c3d1f33.xhtml">https://www.safaribooksonline.com/library/view/mastering-geospatial-analysis/9781788293334/44f54df4-f6c9-467d-8057-dee20c3d1f33.xhtml</a></p></li>

<li><p><a href="https://datascienceplus.com/leveraging-hive-with-spark-using-python/">https://datascienceplus.com/leveraging-hive-with-spark-using-python/</a></p></li>

<li><p><a href="http://python101.pythonlibrary.org/chapter34_sqlalchemy.html">a nice tutorial for beginners</a></p></li>

<li><p><a href="https://stackoverflow.com/questions/23185319/why-is-loading-sqlalchemy-objects-via-the-orm-5-8x-slower-than-rows-via-a-raw-my">sqlalchemy performance issues</a></p></li>
</ul>

<h2 id="4-subjects-still-to-cover">4. Subjects still to cover</h2>

<ul>
<li>pyHive + sqlAlchemy (TODO)</li>
</ul>

</div>

<div class="jumbotron text-center" id="footer">

  made using &emsp;
  <br class="d-xl-none">
  <a href="https://gohugo.io/">Hugo</a> |
  <a href="https://getbootstrap.com/">Bootstrap</a> |
  <a href="https://highlightjs.org/">highlightjs</a> |
  <a href="https://bookdown.org/yihui/blogdown/">blogdown</a> |
  <a href="https://fonts.google.com/">Google fonts</a> &emsp;
  <br class="d-xl-none">
  <a href="https://github.com/tomis9/cookbook">github</a> |
  <a href="https://travis-ci.org/tomis9/cookbook">travis-ci</a> <a href="https://travis-ci.org/tomis9/cookbook"><img src="https://api.travis-ci.org/tomis9/cookbook.png"></img></a> |
  <a href="https://hub.docker.com/r/tomis9/cookbook">docker hub</a> &emsp;
  <br class="d-xl-none">
  <a href="https://aws.amazon.com/s3">Amazon S3</a> |
  <a href="https://aws.amazon.com/route53/">Amazon Route 53</a> &emsp;
  <br class="d-xl-none">
  Copyright &copy; 2019 tomis9

</div>

</body>



<script src="https://tomis9.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


<script src="https://tomis9.github.io/js/bootstrap-toc.js"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


<script>
$(window).scroll(function() {
  
  if ($(window).scrollTop() > 100 ) {
    $('.navbar').removeClass('navbar-hide');
    $('.navbar').addClass('navbar-show');
  } else {
    $('.navbar').removeClass('navbar-show');
    $('.navbar').addClass('navbar-hide');
  };   	
});
</script>

</html>

