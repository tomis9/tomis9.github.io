<!DOCTYPE html>
<html lang="en">
<head>

  <title>tomis9&#39;s cookbook</title>
  <link rel="shortcut icon" type='image/x-icon' href="https://tomis9.github.io/favicon.ico"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  
  <link rel="stylesheet" href="https://tomis9.github.io/css/bootstrap-toc.css">

  
  <link rel="stylesheet" href="https://tomis9.github.io/css/darcula.css">

  
  <link rel="stylesheet" href="https://tomis9.github.io/css/style.css">

  
  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">        
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Fascinate&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">

</head>


<body data-spy="scroll" data-target="#toc">



<nav id="navbar" class="navbar navbar-expand-md fixed-top navbar-hide transition">

  
  <a class="navbar-brand"></a>

  <button class="navbar-toggler float-xs-right" data-toggle="collapse" data-target="#collapsibleNavbar">
    Menu
  </button>

  <div class="collapse navbar-collapse" id="collapsibleNavbar">

    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://tomis9.github.io">Home</a>
      </li>
      
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Python</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/beautiful_soup/">beautiful soup</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/decorators/">decorators</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/sqlalchemy/">sqlAlchemy</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/testing/">testing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">R</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/cinr/">C in R</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rmariadb/">RMariaDB (former RMySQL)</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rcpp/">Rcpp</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/classess4/">classes - S4</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/data.table/">data.table</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/debugging/">debugging</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/ggplot2/">ggplot2</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/lubridate/">lubridate</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/packages/">packages</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rtags/">rTags</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/reshape2/">reshape2</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rstanarm/">rstanarm</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/shiny/">shiny</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/sqldf/">sqldf</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/tidyverse/">tidyverse</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Data engineering</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/airflow/">airflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/hadoop/">hadoop</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/logging/">logging</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/spark/">spark</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/useful_processing/">useful processing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Machine learning</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/ml/">basic machine learning algorithms</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/decision_trees/">decision trees</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/learning_tensorflow/">learning tensorflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/validation/">model validation</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/nls/">nls</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pytorch/">pytorch</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/tensorflow/">tensorflow</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/useful_processing/">useful processing</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">DevOps</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/docker/">docker</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/flask/">flask</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/git/">git</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/heroku/">heroku</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/mesos/">mesos</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pyenv/">pyenv, virtualenv, freeze</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/rocker/">rocker</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/testing/">testing</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/vagrant/">vagrant</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">Projects</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/vim_vs_emacs/">vim vs emacs - text mining to settle the editor war</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/cookbook/">writing a cookbook</a>
          
        </div>
      </li>
    
      
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown">scratchpad</a>
        <div class="dropdown-menu scrollable-menu">
          
            <a class="dropdown-item" href="https://tomis9.github.io/hugo/">Hugo</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/file/">Rmarkdown total basics</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/caffee/">caffee</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/cassandra/">cassandra</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/featuretools/">featuretools</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/gitlab_ci/">gitlab-ci</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/kafka/">kafka</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/marathon/">marathon</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/nlp/">nlp</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/pandas/">pandas</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/passing_arguments/">passing arguments to scripts</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/redis/">redis</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/tensorflow_serving/">tensorflow_serving</a>
          
            <a class="dropdown-item" href="https://tomis9.github.io/theano/">theano</a>
          
        </div>
      </li>
    
    </ul>

  </div>  

</nav>



<div class="jumbotron text-center" id="header">

  <div id="header-title">
      <a href="https://tomis9.github.io">tomis9&#39;s cookbook</a>
  </div>

  <p style="color: white;">data science tutorials and snippets prepared by tomis9</p> 

</div>


<nav id="toc" data-toggle="toc" class="sticky-top d-none d-xl-block"></nav>

<div class="article">

<div class="article-categories">
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://tomis9.github.io/categories/machine-learning" role="button">Machine learning </a>
    &emsp;
  
    <object style="vertical-align:middle" type="image/svg+xml" data="/folder.svg" height="15px" width="15px"></object> 
    <a href="https://tomis9.github.io/categories/python" role="button">Python </a>
    &emsp;
  </br>
</div>
<div class="article-title">
  
  tensorflow

</div>
<div class="article-info">
    Jan 1, 2019 &emsp;  &emsp; 5 minutes read
</div>



<h2 id="1-what-is-tensorflow-and-why-would-you-use-it">1. What is tensorflow and why would you use it?</h2>

<ul>
<li><p>tensorflow is a machine learning framework</p></li>

<li><p>which has APIs to Python, C++ and R</p></li>

<li><p>and let&rsquo;s you evaluate any machine learning algorithm, especially deep learning:</p>

<ul>
<li><p>quickly (all the computations are performed in C++)</p></li>

<li><p>easily - you can view your results in a GUI - Tensorboard</p></li>

<li><p>on a huge amount of data, as tensorflow scales easily to many machines and can even make use of GPU.</p></li>
</ul></li>
</ul>

<h2 id="2-a-simple-example-linear-regression">2. A simple example - linear regression</h2>

<p>There are two additional files used in this example: <a href="functions.py">functions.py</a> and <a href="logging_config.json">logging_config.json</a>. I will not go through any of them, as they do not use tensorflow at all.</p>

<p>We will be working on a well-known housing data available in sklearn.</p>

<pre><code class="language-python">import tensorflow as tf
import numpy as np
import logging.config
import functions
import json
from datetime import datetime

np.set_printoptions(suppress=True)

# 1 - logging
now = datetime.utcnow().strftime(&quot;%Y%m%d%H%M%S&quot;)
root_logdir = &quot;tf_logs&quot;
logdir = &quot;{}/run-{}/&quot;.format(root_logdir, now)

with open('./logging_config.json') as f:
    config = json.load(f)

logging.config.dictConfig(config)
logger = logging.getLogger('base')

# 2
logger.info(&quot;setting metaparameters&quot;)
n_epochs = 10
learning_rate = 0.01
batch_size = 100
logger.info(&quot;n_epochs: {}, learning_rate: {}, batch_size: {}&quot;
            .format(n_epochs, learning_rate, batch_size))

# 3
logger.info(&quot;data preparation&quot;)
X_np, y_np = functions.get_data()
m, n = X_np.shape
X_split, y_split, n_batches = functions.split_data(X_np, y_np, batch_size, m)


# 4
logger.info(&quot;starting construction phase&quot;)
X = tf.placeholder(tf.float32, shape=(None, n), name=&quot;X&quot;)
y = tf.placeholder(tf.float32, shape=(None, 1), name=&quot;y&quot;)

theta = tf.Variable(tf.random_uniform([n, 1], -1.0, 1.0), name=&quot;theta&quot;)
y_pred = tf.matmul(X, theta, name=&quot;predictions&quot;)

# 5
with tf.name_scope(&quot;loss&quot;) as scope:
    error = y_pred - y
    mse = tf.reduce_mean(tf.square(error), name=&quot;mse&quot;)

optimizer = tf.train.GradientDescentOptimizer(learning_rate=learning_rate)
training_op = optimizer.minimize(mse)

# 6
init = tf.global_variables_initializer()
saver = tf.train.Saver()

# 7
mse_summary = tf.summary.scalar('MSE', mse)
file_writer = tf.summary.FileWriter(logdir, tf.get_default_graph())
logger.info(&quot;ending construction phase&quot;)

# 8
logger.info(&quot;starting execution&quot;)
with tf.Session() as sess:
    # 6
    # saver.restore(sess, &quot;/tmp/my_model_final.ckpt&quot;)

    sess.run(init)

    for epoch in range(n_epochs):
        for batch_index in range(n_batches):
            # 9
            X_batch, y_batch = X_split[batch_index], y_split[batch_index]

            if batch_index % 10 == 0:
                summary_str = mse_summary.eval(feed_dict={X: X_batch,
                                                          y: y_batch})
                step = epoch * n_batches + batch_index
                # 10
                file_writer.add_summary(summary_str, step)

            # 11
            sess.run(training_op, feed_dict={X: X_batch, y: y_batch})

        logger.info(&quot;Epoch {}, MSE = {}&quot;
                    .format(epoch, mse.eval(feed_dict={X: X_batch,
                                                       y: y_batch})))

    # 12
    best_theta = theta.eval()

    # 13
    save_path = saver.save(sess, &quot;/tmp/my_model_final.ckpt&quot;)
    file_writer.close()

logger.info(&quot;execution ended&quot;)

# 14
pd_comp = functions.compare_scores(X_np, y_np, best_theta.ravel())
logger.info(pd_comp)
</code></pre>

<p>What happened here?</p>

<ol>
<li><p>tensorflow logging is usefull if you want to see the steps of your calculations in Tensorboard. During every execution of your code, you should provide a different logging directory. Using timestamps is a comfortable way to achieve this.</p></li>

<li><p>Metaparameters for the algorithm. 10 epochs is enough for SGD to reach the minimum of Least Squares.</p></li>

<li><p>Preparing the dataset. I split it into batches right here, which is not the nicest solution, but sufficient for the purposes of this tutorial. (TODO)</p></li>

<li><p>This is where graph creation beging:</p>

<ul>
<li><p>creating placeholders, which are empty slots for the data. In general, in tensorflow your create variables for parameter values and placeholders for the data.</p></li>

<li><p>as you can see, creating computations, like matrix multipication, is rather straightforward, but remember to give your new variable a <code>name</code> in the tendorflow graph.</p></li>
</ul></li>

<li><p>You can encapsulate several nodes into one scope, which will make the final graph easier to read. Here we also create an optimiser, which is Gradient Descent in this case, and minimisation target: mse.</p></li>

<li><p>This is where the graph definition ends. Now we prepare for the execution, first by initialising the variables (or, strictly speaking, creating an initialiser). We also create a saver, which saves the parameters of the model to a file.</p></li>

<li><p>Here we declare what we want to export to our log file. Clearly we don&rsquo;t have to export anything nor even use a log file.</p></li>

<li><p>Execution phase starts with creating a session. All the computations are run within a session, so it is convenient to use the <code>with</code> clause, which will eventually close the session for us, even if an exception occurs.</p></li>

<li><p>In every epoch, for every batch we choose a subset of our dataset.</p></li>

<li><p>Every tenth batch produces a tensorflow log message, which we will be able to see plotted in Tensorboard.</p></li>

<li><p>This is where the cumputation is run, e.g. the gradient is calculated and the parameter values are updated. Notice that we have to <code>feed_dict</code> the values of the placeholders with the data.</p></li>

<li><p>Let&rsquo;s save the resulting parameters to a variable. So far this is our goal - to compare the results of tensorflow optimisation to sklearn regression.</p></li>

<li><p>We save our model. We don&rsquo;t have to do that, but it may come up useful in the future.</p></li>

<li><p>We compare the results with sklearn.linear_model (more on that <a href="tomis9.githu.io/sklearn_regerssion">here</a>). They are almost identical.</p></li>
</ol>

<h2 id="3-tensorboard">3. Tensorboard</h2>

<p>I mentioned several times that Tensorboard is a nice and usefull tool for diagnosing our algorithm.</p>

<p>Simply start it with</p>

<pre><code>tensorboard --logdir tf_logs/  
</code></pre>

<p>I believe the interface is simple enough so it needs no tutorial :)</p>

<h2 id="3-useful-links">3. Useful links</h2>

<ul>
<li><p><a href="http://shop.oreilly.com/product/0636920052289.do">Hands-On Machine Learning with Scikit-Learn and TensorFlow</a> - definitely the best book on machine learning I&rsquo;ve ever read, the second best is <a href="http://www.dataminingbook.info/pmwiki.php">Data mining and analysis</a></p></li>

<li><p><a href="https://github.com/yahoo/TensorFlowOnSpark">Tensorflow on Spark</a> - an interesting combo</p></li>

<li><p><a href="https://tensorflow.rstudio.com/">tensorflow for R</a></p></li>

<li><p><a href="https://www.r-bloggers.com/step-by-step-tutorial-deep-learning-with-tensorflow-in-r/">example of tensorflow for R</a></p></li>

<li><p><a href="https://github.com/aymericdamien/TensorFlow-Examples">good examples of tensorflow</a></p></li>

<li><p><a href="https://towardsdatascience.com/lstm-by-example-using-tensorflow-feb0c1968537">LSTM using tensorflow</a></p></li>

<li><p><a href="https://www.tensorflow.org/tutorials/representation/word2vec">word2vec using tensorflow</a></p></li>
</ul>

<p><em>tensorflow 2.0 has just been released! <a href="https://www.youtube.com/watch?v=k5c-vg4rjBw">https://www.youtube.com/watch?v=k5c-vg4rjBw</a></em></p>

</div>

<div class="jumbotron text-center" id="footer">

  made using &emsp;
  <br class="d-xl-none">
  <a href="https://gohugo.io/">Hugo</a> |
  <a href="https://getbootstrap.com/">Bootstrap</a> |
  <a href="https://highlightjs.org/">highlightjs</a> |
  <a href="https://bookdown.org/yihui/blogdown/">blogdown</a> |
  <a href="https://fonts.google.com/">Google fonts</a> &emsp;
  <br class="d-xl-none">
  <a href="https://github.com/tomis9/cookbook">github</a> |
  <a href="https://travis-ci.org/tomis9/cookbook">travis-ci</a> <a href="https://travis-ci.org/tomis9/cookbook"><img src="https://api.travis-ci.org/tomis9/cookbook.png"></img></a> |
  <a href="https://hub.docker.com/r/tomis9/cookbook">docker hub</a> &emsp;
  <br class="d-xl-none">
  <a href="https://aws.amazon.com/s3">Amazon S3</a> |
  <a href="https://aws.amazon.com/route53/">Amazon Route 53</a> &emsp;
  <br class="d-xl-none">
  Copyright &copy; 2019 tomis9

</div>

</body>



<script src="https://tomis9.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


<script src="https://tomis9.github.io/js/bootstrap-toc.js"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


<script>
$(window).scroll(function() {
  
  if ($(window).scrollTop() > 100 ) {
    $('.navbar').removeClass('navbar-hide');
    $('.navbar').addClass('navbar-show');
  } else {
    $('.navbar').removeClass('navbar-show');
    $('.navbar').addClass('navbar-hide');
  };   	
});
</script>

</html>

